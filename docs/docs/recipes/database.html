<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="alternate" type="application/rss+xml" href="/Etl.Net/blog/rss.xml" title="ETL.NET Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/Etl.Net/blog/atom.xml" title="ETL.NET Blog Atom Feed"><title data-react-helmet="true">Deal with databases | ETL.NET</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://paillave.github.io//Etl.Net/img/full-black-logo.png"><meta data-react-helmet="true" name="twitter:image" content="https://paillave.github.io//Etl.Net/img/full-black-logo.png"><meta data-react-helmet="true" property="og:url" content="https://paillave.github.io//Etl.Net/docs/recipes/database"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Deal with databases | ETL.NET"><meta data-react-helmet="true" name="description" content="ETL.NET official extensions for database permit to save correlated or not correlated using a smart upsert method."><meta data-react-helmet="true" property="og:description" content="ETL.NET official extensions for database permit to save correlated or not correlated using a smart upsert method."><link data-react-helmet="true" rel="shortcut icon" href="/Etl.Net/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://paillave.github.io//Etl.Net/docs/recipes/database"><link data-react-helmet="true" rel="alternate" href="https://paillave.github.io//Etl.Net/docs/recipes/database" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://paillave.github.io//Etl.Net/docs/recipes/database" hreflang="x-default"><link rel="stylesheet" href="/Etl.Net/assets/css/styles.5001f6a5.css">
<link rel="preload" href="/Etl.Net/assets/js/runtime~main.2fb7135c.js" as="script">
<link rel="preload" href="/Etl.Net/assets/js/main.fdff19b8.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/Etl.Net/"><img src="/Etl.Net/img/logo.svg" alt="Etl.Net Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/Etl.Net/img/logo.svg" alt="Etl.Net Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">ETL.NET</b></a><a class="navbar__item navbar__link navbar__link--active" href="/Etl.Net/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/Etl.Net/blog">Blog</a></div><div class="navbar__items navbar__items--right"><div class="navbar__search searchBarContainer_MM2z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_s5VG searchBarLoadingRing_2jQk"><div></div><div></div><div></div><div></div></div></div><a href="https://github.com/paillave/Etl.Net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" href="/Etl.Net/docs/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Get Started</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Tutorial</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Patterns &amp; Recipes</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/dealWithFiles">Deal with files and protocols</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/normalize">Normalize a flat structure</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/writeInFiles">Create files</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/Etl.Net/docs/recipes/database">Deal with databases</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/handleTraces">Handle traces</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/consoleApplication">Make a console application</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/getManyData">Get many data</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/linkStreams">Combine streams</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/useExternalData">Inject values in a process</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/reduceAndAggregate">Reduce/aggregate and distinct</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/changeData">Change/Create in stream data</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/changeScope">Restrict rows</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/Etl.Net/docs/recipes/sorting">Sorting</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Operators</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Deal with databases</h1></header><p>ETL.NET official extensions for database permit to save correlated or not correlated using a smart upsert method.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="without-entity-framework"></a>Without Entity Framework<a class="hash-link" href="#without-entity-framework" title="Direct link to heading">#</a></h2><p>ETL.NET official extension to access SQL server without Entity Framework is <code>Paillave.EtlNet.SqlServer</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="setup-the-connection-without-entity-framework"></a>Setup the connection without Entity Framework<a class="hash-link" href="#setup-the-connection-without-entity-framework" title="Direct link to heading">#</a></h3><p>Obviously, for Sql Server operators to work, they need a connection to the database. <a href="/Etl.Net/docs/recipes/useExternalData">Dependency injection</a> must be used to inject the connection in the process when triggering the process with <code>ProcessRunner</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var processRunner = StreamProcessRunner.Create&lt;string&gt;(DefineProcess);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">using (var cnx = new SqlConnection(args[1]))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    cnx.Open();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var executionOptions = new ExecutionOptions&lt;string&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Resolver = new SimpleDependencyResolver().Register(cnx),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var res = await processRunner.ExecuteAsync(args[0], executionOptions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Check <a href="/Etl.Net/docs/recipes/useExternalData">here</a> to have more details about dependency injection.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="read-without-entity-framework"></a>Read without Entity Framework<a class="hash-link" href="#read-without-entity-framework" title="Direct link to heading">#</a></h3><p>Reading data from the database is based on a <code>CrossApply</code> operator type. This means that the operation will execute the query and issue new rows <strong>for each event of the input stream</strong>.</p><p>Get data with no criteria using a class that matches <strong>exactly</strong> the structure of the returned dataset:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">contextStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .CrossApplySqlServerQuery(&quot;get people&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .FromQuery(&quot;select p.* from dbo.Person as p&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .WithMapping&lt;Person&gt;())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show people on console&quot;, i =&gt; Console.WriteLine($&quot;{i.FirstName} {i.LastName}: ${i.DateOfBirth:yyyy-MM-dd}&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here is how to do to accomplish the same if working using a class that doesn&#x27;t match the structure of even with an anonymous type:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">contextStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .CrossApplySqlServerQuery(&quot;get people&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .FromQuery(&quot;select p.* from dbo.Person as p&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .WithMapping(i =&gt; new</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name = i.ToColumn(&quot;FirstName&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Birthday = i.ToDateColumn(&quot;DateOfBirth&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show people on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Name}: ${i.Birthday:yyyy-MM-dd}&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To apply a criteria for each execution, the input payload must contain properties with a name and a type that corresponds the necessary SQL variable that is used in the SQL statement:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">contextStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Select(&quot;build criteria&quot;, i =&gt; new { Reputation = 345 })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .CrossApplySqlServerQuery(&quot;get people&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .FromQuery(&quot;select p.* from dbo.Person as p where p.Reputation = @Reputation&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .WithMapping(i =&gt; new</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name = i.ToColumn(&quot;FirstName&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Birthday = i.ToDateColumn(&quot;DateOfBirth&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show people on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Name}: ${i.Birthday:yyyy-MM-dd}&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="lookup-without-entity-framework"></a>Lookup without Entity Framework<a class="hash-link" href="#lookup-without-entity-framework" title="Direct link to heading">#</a></h3><p>To make a lookup, extensions for Sql Server don&#x27;t provide any operator out of the box. The work around is to use the in memory lookup of ETL.NET core.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var authorStream = contextStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .CrossApplySqlServerQuery(&quot;get authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .FromQuery(&quot;select a.* from dbo.Author as a&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .WithMapping(i =&gt; new</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Id = i.ToNumberColumn&lt;int&gt;(&quot;Id&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name = i.ToColumn(&quot;Name&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Reputation = i.ToNumberColumn&lt;int&gt;(&quot;Reputation&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }));</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Lookup(&quot;get related author&quot;, authorStream,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        l =&gt; l.AuthorId,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        r =&gt; r.Id,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        (l, r) =&gt; new { Post = l, Author = r })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Post.Title} ({i.Author.Name})&quot;));</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-warning alert alert--danger"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>warning</h5></div><div class="admonition-content"><p>Keep in mind that the lookup operator is compelled to wait for the whole target stream to be completed to actually start the actual lookup operation. Of course, <strong>at the same time it is storing the full right stream in memory, it does the same with the left stream the right one is completed</strong>. To avoid this, consider the <code>LeftJoin</code> operator, but this one need both streams to be sorted on the pivot value.</p></div></div><p>As mentioned in the previous warning, the <code>Lookup</code> operator is not without problem, and the alternative can be the <code>LeftJoin</code> of both input stream are properly sorted. With the two stream sorted on the pivot key, just the latest row of both streams will be stored in memory. If any stream is already sorted, it makes absolutely no sense to sort it. This is where <code>EnsureSorted</code> comes. It permits to check that the stream is properly sorted. If it is not properly sorted, and error will be raised and the process will stop. For the target stream, <code>EnsureKeyed</code> will make the same but will check that there is no duplicate either.</p><p>This way, the process will be as fast and memory saving as it can be, even with billions rows.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var authorStream = contextStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .CrossApplySqlServerQuery(&quot;get authors&quot;, o =&gt; o</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .FromQuery(&quot;select a.* from dbo.Author as a order by a.Id&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .WithMapping(i =&gt; new</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Id = i.ToNumberColumn&lt;int&gt;(&quot;Id&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Name = i.ToColumn(&quot;Name&quot;),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Reputation = i.ToNumberColumn&lt;int&gt;(&quot;Reputation&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }))</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">    .EnsureKeyed(&quot;ensure authors are sorted by Id with no duplicate without actually sorting it&quot;, i =&gt; i.Id);</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">    .EnsureSorted(&quot;ensure posts are sorted by AuthorId without actually sorting it&quot;, i =&gt; i.AuthorId);</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">    .LeftJoin(&quot;get related author&quot;, authorStream,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        l =&gt; l.AuthorId,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        r =&gt; r.Id,</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        (l, r) =&gt; new { Post = l, Author = r })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Post.Title} ({i.Author.Name})&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Look <a href="/Etl.Net/docs/recipes/linkStreams">here</a> for more details about how to combine streams.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="save-without-entity-framework"></a>Save without Entity Framework<a class="hash-link" href="#save-without-entity-framework" title="Direct link to heading">#</a></h3><p>Saving data in the database works with the operator <code>SqlServerSave</code>. For each row, this operator does the following:</p><ul><li>Tries the get an occurrence with the same pivot value</li><li>If not found create a new row by excluding values not to save (if any). If found, update the retrieved row - in the same manner.</li><li>Save the updated or created row</li><li>Get every value as it is in the database to update the current payload with it</li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The payload to be saved must be a <strong>class</strong> that has a structure that must match the target table.</p></div></div><p>Here is how to save a list of people that are identified by their <code>Email</code> in a table that has a primary key <code>Id</code> that is auto generated:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">peopleStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .SqlServerSave(&quot;upsert using Email as key and ignore the Id&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ToTable(&quot;dbo.Person&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .SeekOn(p =&gt; p.Email)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .DoNotSave(p =&gt; p.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The property <code>Id</code> of the person will be updated with the <code>Id</code> from the update or created row.</p><p>If the business key is on several field, and/or if there are several column that are computed at database level, the upsert must be done this way:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">peopleStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .SqlServerSave(&quot;upsert using Email as key and ignore the Id&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ToTable(&quot;dbo.Person&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .SeekOn(p =&gt; new { p.DateOfBirth, p.Number })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .DoNotSave(p =&gt; new { p.Id, p.Timestamp }));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Of course, making a regular insert with no update is possible:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">traceStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .SqlServerSave(&quot;insert in a trace table&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .ToTable(&quot;dbo.Trace&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .DoNotSave(p =&gt; p.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>If the class has the same name than the target table and that the target table is in the default schema (in 99% of cases: <code>dbo</code>), it is not necessary to mention the target table explicitly:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">traceStream.SqlServerSave(&quot;insert in a trace table&quot;, o =&gt; o.DoNotSave(p =&gt; p.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>For the moment, saving with the SQL extension executes an <strong>upsert sql statement for each row</strong> behind the scenes. It doesn&#x27;t proceed using bulk load with one single merge statement for a full bulk of rows. To have a bulkload, the extension using Entity Framework must be used instead.</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="execute-a-sql-process-for-every-row"></a>Execute a SQL process for every row<a class="hash-link" href="#execute-a-sql-process-for-every-row" title="Direct link to heading">#</a></h3><p>Calling an arbitrary SQL statement or a stored procedure is made with the operator <code>ToSqlCommand</code>. It is given a statement with parameters that must have their equivalent in properties of the payload of the stream.</p><p>Here, the goal is to change the reputation for the one who have 345 and 45 as a current reputation:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">contextStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .CrossApply(&quot;build criteria&quot;, i =&gt; new[] </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new { Reputation = 345, NewReputation = 346 },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new { Reputation = 45, NewReputation = 201 }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .ToSqlCommand(&quot;update reputation&quot;, </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;update p set Reputation = @NewReputation from dbo.Person as p where p.Reputation = @Reputation&quot;);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><code>ToSqlCommand</code> always returns the input events as is. The following can be done for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">contextStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .CrossApply(&quot;build criteria&quot;, i =&gt; new[] </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new { Reputation = 345, NewReputation = 346 },</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        new { Reputation = 45, NewReputation = 201 }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .ToSqlCommand(&quot;update reputation&quot;, </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;update p set Reputation = @NewReputation from dbo.Person as p where p.Reputation = @Reputation&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .ToSqlCommand(&quot;update reputation like before&quot;, </span></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;update p set Reputation = @Reputation from dbo.Person as p where p.Reputation = @NewReputation&quot;);</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="using-entity-framework"></a>Using Entity Framework<a class="hash-link" href="#using-entity-framework" title="Direct link to heading">#</a></h2><p>ETL.NET official extension to access databases with Entity Framework is <code>Paillave.EtlNet.EntityFrameworkCore</code>.</p><p>Most of things related to Sql Server extension have their equivalent in the Entity Framework extension.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="setup-entity-framework-connection"></a>Setup Entity Framework connection<a class="hash-link" href="#setup-entity-framework-connection" title="Direct link to heading">#</a></h3><p>As Entity Framework needs a connection as well, it will need to be injected in the same way than above in the process:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">var processRunner = StreamProcessRunner.Create&lt;string&gt;(DefineProcess);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">using (var dbCtx = new SimpleTutorialDbContext(args[1]))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var executionOptions = new ExecutionOptions&lt;string&gt;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        Resolver = new SimpleDependencyResolver().Register&lt;DbContext&gt;(dbCtx),</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    };</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    var res = await processRunner.ExecuteAsync(args[0], executionOptions);</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Check <a href="/Etl.Net/docs/recipes/useExternalData">here</a> to have more details about dependency injection.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="read-using-entity-framework"></a>Read using Entity Framework<a class="hash-link" href="#read-using-entity-framework" title="Direct link to heading">#</a></h3><p>The operator <code>EfCoreSelect</code> provides a wrapper to get an entity set along with the current value of the stream for an <code>IQueryable</code> to be returned:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">contextStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSelect(&quot;get posts&quot;, (o, row) =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Set&lt;Post&gt;()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Where(i =&gt; i.Title.Contains(row.TitleCriteria)))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine(i.Title));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Getting one single value per event issued works in a similar way:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSelectSingle(&quot;get corresponding authors&quot;, (o, row) =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Set&lt;Author&gt;()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Where(i =&gt; i.Id == row.AuthorId))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Name}&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="lookup-with-entity-framework"></a>Lookup with Entity Framework<a class="hash-link" href="#lookup-with-entity-framework" title="Direct link to heading">#</a></h3><p>What is mentioned above get one item per event, but it will always run a query per event, and it is hardly possible to combine the output with the input.</p><p>If all this is an issue the way to go is the proper lookup system dedicated for Entity Framework <code>EfCoreLookup</code>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreLookup(&quot;get related authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Set&lt;Author&gt;()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .On(i =&gt; i.AuthorId, i =&gt; i.Id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Select((l, r) =&gt; new { Post = l, Author = r }))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Post.Title} ({i.Author.Name})&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>By default <code>EfCoreLookup</code> takes the full target dataset and keeps it in memory after making a dictionary out of it based on the targeted key. In some situations, the target dataset is too big to be stored in memory. So the default behavior is <strong>wrong</strong>. There are two solution for this.</p><p>The first solution can be used in case of only a subset of the target dataset is necessary. Here is how to do:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreLookup(&quot;get related authors&quot;, o =&gt; o</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .Query(o =&gt; o.Set&lt;Author&gt;().Where(a =&gt; a.TypeId == 6))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .On(i =&gt; i.AuthorId, i =&gt; i.Id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Select((l, r) =&gt; new { Post = l, Author = r }))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Post.Title} ({i.Author.Name})&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The second solution suits cases when there is not specific subset in the target dataset. The principle is that at each row, the lookup tries to get the related target item is in the cache. If it is not in the cache it will query it against the database, store in the cache, and return it. To activate this behavior, <code>NoCacheFullDataset</code> must be set after the <code>Select</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreLookup(&quot;get related authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Set&lt;Author&gt;()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .On(i =&gt; i.AuthorId, i =&gt; i.Id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Select((l, r) =&gt; new { Post = l, Author = r })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .NoCacheFullDataset())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Post.Title} ({i.Author.Name})&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Of course, both solutions can be applied together:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreLookup(&quot;get related authors&quot;, o =&gt; o</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .Query(o =&gt; o.Set&lt;Author&gt;().Where(a =&gt; a.TypeId == 6))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .On(i =&gt; i.AuthorId, i =&gt; i.Id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Select((l, r) =&gt; new { Post = l, Author = r })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .NoCacheFullDataset())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Post.Title} ({i.Author.Name})&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It is also possible to control the size of the cache:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreLookup(&quot;get related authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Set&lt;Author&gt;()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .On(i =&gt; i.AuthorId, i =&gt; i.Id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Select((l, r) =&gt; new { Post = l, Author = r })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .NoCacheFullDataset()</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .CacheSize(500))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Post.Title} ({i.Author.Name})&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Last but not least, in a context of a normalization, the lookup can permit to create the corresponding target item if not found in the target dataset:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">postStream</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreLookup(&quot;get related authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Set&lt;Author&gt;()</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .On(i =&gt; i.AuthorId, i =&gt; i.Id)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Select((l, r) =&gt; new { Post = l, Author = r })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .CreateIfNotFound(p =&gt; new Author { Name = $&quot;Name {p.AuthorId}&quot; }))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show value on console&quot;, i =&gt; Console.WriteLine($&quot;{i.Post.Title} ({i.Author.Name})&quot;));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p>In the context of a normalization, if all the data comes from the same source, using lookup operators like <code>Lookup</code> or <code>EfCoreLookup</code> or even <code>LeftJoin</code> is not the best way to go. Use the <a href="/Etl.Net/docs/recipes/normalize">correlation system</a> for this.</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="save-using-entity-framework"></a>Save using Entity Framework<a class="hash-link" href="#save-using-entity-framework" title="Direct link to heading">#</a></h3><p>Except the fact you can she the same exact context between an application and the ETL process, except the fact no mapping is necessary as it is already done in the definition of the context, using ETL.NET Entity Framework extensions offers a very fast bulkload for any use case plus some extra features.</p><p>The upsert will also get all the computed/readonly fields at database side and update the row with it.</p><p>The operator <code>EfCoreSave</code> makes an upsert with Entity Framework by using the primary key that is defined in the database context:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Select(&quot;create author instance&quot;, i =&gt; new Author { Email = i.Email, Name = i.Author })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save authors&quot;)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show output id on console&quot;, i =&gt; Console.WriteLine(i.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To make an upsert using a pivot key that is different than the primary key the option <code>SeekOn</code> must be mentioned:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Select(&quot;create author instance&quot;, i =&gt; new Author { Email = i.Email, Name = i.Author })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save authors&quot;, o =&gt; o</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .SeekOn(i =&gt; i.Email))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show output id on console&quot;, i =&gt; Console.WriteLine(i.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>I can also be written the following way to permit the pivot key to be composed with several fields:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Select(&quot;create author instance&quot;, i =&gt; new Author { Email = i.Email, Name = i.Author })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save authors&quot;, o =&gt; o</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .SeekOn(i =&gt; new { i.Email }))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show output id on console&quot;, i =&gt; Console.WriteLine(i.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>It can happen that an object can have several several business keys. We can imagine for example, a author has a social security number as an identifier, and an author reference. We want the system to get the author based on his social security number first, and if it is not found this way, it tries to use the author reference instead. <code>AlternativelySeekOn</code> option is meant to accomplish this purpose:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Select(&quot;create author instance&quot;, i =&gt; new Author { Email = i.Email, Name = i.Author })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .SeekOn(i =&gt; new { i.SocialSecurityNumber })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .AlternativelySeekOn(i =&gt; { i.AuthorReference }))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show output id on console&quot;, i =&gt; Console.WriteLine(i.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To insert only rows that don&#x27;t exist already but still by retrieving the computed/readonly fields at database side and set it on the local row, the option <code>DoNotUpdateIfExists</code> must be used:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Select(&quot;create author instance&quot;, i =&gt; new Author { Email = i.Email, Name = i.Author })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .SeekOn(i =&gt; new { i.Email })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .DoNotUpdateIfExists())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show output id on console&quot;, i =&gt; Console.WriteLine(i.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To insert ALL the rows into the database with no exception, use <code>InsertOnly</code> option:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save traces&quot;, o =&gt; o</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .InsertOnly())</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show trace id on console&quot;, i =&gt; Console.WriteLine(i.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To save an object that is not the actual payload of events of the stream, the entity to save must be specified with the option <code>Entity</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save authors&quot;, o =&gt; o</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .Entity(i=&gt; new Author { Email = i.Email, Name = i.Author })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .SeekOn(i =&gt; new { i.SocialSecurityNumber }))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show output id on console&quot;, i =&gt; Console.WriteLine(i.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The output stream issues payload that are the entity updated accordingly to what is in the database. To get an output that is a combination of this entity and of the initial payload, use the option <code>Output</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Entity(i=&gt; new Author { Email = i.Email, Name = i.Author })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .SeekOn(i =&gt; new { i.SocialSecurityNumber })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .Output((r, e) =&gt; new { AuthorRow = r, SavedEntity = e }))</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show output id on console&quot;, i =&gt; Console.WriteLine(i.SavedEntity.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-important alert alert--info"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>important</h5></div><div class="admonition-content"><p><strong>By default, save operation of the EF Core extension doesn&#x27;t fully use EF Core to make saves</strong>. It uses metadata of the <code>DbContext</code> to inspect the mapping, computed columns, primary keys, converters and TPH inheritance specifications. With these metadata, the extension makes a bulkload and runs suitable <code>MERGE</code> or <code>INSERT</code> SQL statements. <strong>In this default mode, the extension works only on SQL Server databases</strong>. Of course, this is way faster that actually fully using EF Core. </p><p>This way to use the extension takes in charge every capabilities of EF Core except for 2 exceptions:</p><ul><li>Owned object (<code>OwnsOne</code> or <code>OwnsMany</code>)</li><li>Table-per-Type inheritance (Table-per-Hierarchy is totally taken in charge)</li></ul><p>On this version of the extension, <strong>this default mode needs the connection to be able to create and delete tables in the database</strong>. Later on, temporary tables may be used instead, and this requirement won&#x27;t applicable anymore.</p><p>To fully use EF Core, and therefore being able to work with any database that EF Core takes in charge, set the option <code>WithMode</code> to <code>SaveMode.EntityFrameworkCore</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cs"><pre tabindex="0" class="prism-code language-cs codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">stream </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .EfCoreSave(&quot;save authors&quot;, o =&gt; o</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .Entity(i=&gt; new Author { Email = i.Email, Name = i.Author })</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        .SeekOn(i =&gt; new { i.SocialSecurityNumber })</span></span><span class="token-line docusaurus-highlight-code-line" style="color:#393A34"><span class="token plain">        .WithMode(SaveMode.EntityFrameworkCore))</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    .Do(&quot;show output id on console&quot;, i =&gt; Console.WriteLine(i.Id));</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://paillave.github.io/Etl.Net/edit/master/website/docs/recipes/4_database.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/Etl.Net/docs/recipes/writeInFiles"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Create files</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/Etl.Net/docs/recipes/handleTraces"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Handle traces Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#without-entity-framework" class="table-of-contents__link">Without Entity Framework</a><ul><li><a href="#setup-the-connection-without-entity-framework" class="table-of-contents__link">Setup the connection without Entity Framework</a></li><li><a href="#read-without-entity-framework" class="table-of-contents__link">Read without Entity Framework</a></li><li><a href="#lookup-without-entity-framework" class="table-of-contents__link">Lookup without Entity Framework</a></li><li><a href="#save-without-entity-framework" class="table-of-contents__link">Save without Entity Framework</a></li><li><a href="#execute-a-sql-process-for-every-row" class="table-of-contents__link">Execute a SQL process for every row</a></li></ul></li><li><a href="#using-entity-framework" class="table-of-contents__link">Using Entity Framework</a><ul><li><a href="#setup-entity-framework-connection" class="table-of-contents__link">Setup Entity Framework connection</a></li><li><a href="#read-using-entity-framework" class="table-of-contents__link">Read using Entity Framework</a></li><li><a href="#lookup-with-entity-framework" class="table-of-contents__link">Lookup with Entity Framework</a></li><li><a href="#save-using-entity-framework" class="table-of-contents__link">Save using Entity Framework</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Paillave.</div></div></div></footer></div>
<script src="/Etl.Net/assets/js/runtime~main.2fb7135c.js"></script>
<script src="/Etl.Net/assets/js/main.fdff19b8.js"></script>
</body>
</html>